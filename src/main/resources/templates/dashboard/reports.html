<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Điểm Danh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link href="/static/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="container-fluid p-5">
        <div class="row">
            <!-- Sidebar -->
            {% include 'sidebar.html' %}
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Báo Cáo Điểm Danh</h1>
                    <button class="btn btn-success" id="exportReportBtn">
                        <i class="bi bi-file-earmark-excel me-2"></i>Xuất Excel
                    </button>
                </div>

                <!-- Bộ lọc báo cáo -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Tùy Chọn Báo Cáo</h5>
                    </div>
                    <div class="card-body">
                        <form id="reportFilterForm">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Từ Ngày</label>
                                    <input type="date" class="form-control" id="fromDate" name="from_date">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Đến Ngày</label>
                                    <input type="date" class="form-control" id="toDate" name="to_date">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Lớp</label>
                                    <select class="form-select" name="class">
                                        <option value="">Tất cả lớp</option>
                                        <option value="10A1">10A1</option>
                                        <option value="10A2">10A2</option>
                                        <option value="11A1">11A1</option>
                                        <option value="11A2">11A2</option>
                                        <option value="12A1">12A1</option>
                                        <option value="12A2">12A2</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Trạng Thái</label>
                                    <select class="form-select" name="status">
                                        <option value="">Tất cả</option>
                                        <option value="PRESENT">Có mặt</option>
                                        <option value="LATE">Đi muộn</option>
                                        <option value="ABSENT">Vắng mặt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 text-end">
                                    <button type="button" class="btn btn-secondary me-2" id="resetFilterBtn">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Đặt lại
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-funnel me-2"></i>Lọc
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Thống kê tổng quan -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-white bg-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">Tổng Số Lần Điểm Danh</h6>
                                        <p class="card-text display-6">128</p>
                                    </div>
                                    <i class="bi bi-clipboard-data" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">Tỷ Lệ Có Mặt</h6>
                                        <p class="card-text display-6">85%</p>
                                    </div>
                                    <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-danger">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">Tỷ Lệ Vắng Mặt</h6>
                                        <p class="card-text display-6">8%</p>
                                    </div>
                                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biểu đồ thống kê -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Biểu Đồ Thống Kê</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height:300px;">
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bảng báo cáo chi tiết -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Báo Cáo Chi Tiết</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="reportTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Học Sinh</th>
                                        <th>Mã Số</th>
                                        <th>Lớp</th>
                                        <th>Thời Gian</th>
                                        <th>Trạng Thái</th>
                                        <th>Hình Ảnh</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>15/06/2023</td>
                                        <td>Nguyễn Văn A</td>
                                        <td>HS001</td>
                                        <td>10A1</td>
                                        <td>07:15:23</td>
                                        <td><span class="badge bg-success">PRESENT</span></td>
                                        <td><a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="/static/attendance/1.jpg">Xem ảnh</a></td>
                                    </tr>
                                    <tr>
                                        <td>15/06/2023</td>
                                        <td>Trần Thị B</td>
                                        <td>HS002</td>
                                        <td>10A1</td>
                                        <td>07:45:12</td>
                                        <td><span class="badge bg-warning">LATE</span></td>
                                        <td><a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="/static/attendance/2.jpg">Xem ảnh</a></td>
                                    </tr>
                                    <tr>
                                        <td>15/06/2023</td>
                                        <td>Lê Văn C</td>
                                        <td>HS003</td>
                                        <td>10A1</td>
                                        <td>-</td>
                                        <td><span class="badge bg-danger">ABSENT</span></td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>14/06/2023</td>
                                        <td>Nguyễn Văn A</td>
                                        <td>HS001</td>
                                        <td>10A1</td>
                                        <td>07:10:45</td>
                                        <td><span class="badge bg-success">PRESENT</span></td>
                                        <td><a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="/static/attendance/3.jpg">Xem ảnh</a></td>
                                    </tr>
                                    <tr>
                                        <td>14/06/2023</td>
                                        <td>Trần Thị B</td>
                                        <td>HS002</td>
                                        <td>10A1</td>
                                        <td>07:05:32</td>
                                        <td><span class="badge bg-success">PRESENT</span></td>
                                        <td><a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="/static/attendance/4.jpg">Xem ảnh</a></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Xem ảnh -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Ảnh điểm danh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="Ảnh điểm danh">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <script>
        $(document).ready(function() {
            // Khởi tạo DataTable
            $('#reportTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/vi.json'
                },
                order: [[0, 'desc']],
                dom: '<"top"f>rt<"bottom"lip><"clear">'
            });

            // Khởi tạo datepicker
            flatpickr("#fromDate", {
                locale: "vn",
                dateFormat: "d/m/Y",
                defaultDate: new Date()
            });

            flatpickr("#toDate", {
                locale: "vn",
                dateFormat: "d/m/Y",
                defaultDate: new Date()
            });

            // Xử lý sự kiện reset filter
            $('#resetFilterBtn').click(function() {
                $('#reportFilterForm')[0].reset();
            });

            // Xử lý sự kiện xem ảnh
            $('#imageModal').on('show.bs.modal', function(event) {
                var button = $(event.relatedTarget);
                var imageUrl = button.data('image');
                $('#modalImage').attr('src', imageUrl);
            });

            // Khởi tạo biểu đồ
            var ctx = document.getElementById('attendanceChart').getContext('2d');
            var attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['10A1', '10A2', '11A1', '11A2', '12A1', '12A2'],
                    datasets: [
                        {
                            label: 'Có mặt',
                            data: [45, 38, 42, 40, 39, 36],
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            borderWidth: 1
                        },
                        {
                            label: 'Đi muộn',
                            data: [5, 8, 6, 7, 4, 9],
                            backgroundColor: '#ffc107',
                            borderColor: '#ffc107',
                            borderWidth: 1
                        },
                        {
                            label: 'Vắng mặt',
                            data: [2, 4, 3, 5, 3, 6],
                            backgroundColor: '#dc3545',
                            borderColor: '#dc3545',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Số lượng'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Lớp'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Thống Kê Điểm Danh Theo Lớp'
                        }
                    }
                }
            });

            // Xử lý xuất báo cáo
            $('#exportReportBtn').click(function() {
                // Lấy dữ liệu filter
                var formData = $('#reportFilterForm').serialize();
                // Chuyển hướng đến API xuất Excel
                window.location.href = '/api/reports/export?' + formData;
            });
        });
    </script>
</body>
</html>